---
export const prerender = false;

import FullWidthLayout from '../../layouts/FullWidthLayout.astro';
import { getPool } from '../../lib/db';
import { getCollection } from 'astro:content';
import { Icon } from 'astro-icon/components';
import { getFirstAndLastDates } from '../../lib/datelib';
import { Temporal } from '@js-temporal/polyfill';

// Get all activities with their schedule info
const activities = await getCollection('activities');
const now = Temporal.Now.zonedDateTimeISO('America/Louisville');

interface ActivityInfo {
  id: string;
  name: string;
  instructors: string[];
  startDate: string;
  startTime: string;
  duration: string;
  repeat: string;
  firstDate: Temporal.ZonedDateTime | null;
  lastDate: Temporal.ZonedDateTime | null;
  weekday: string;
  formattedTime: string;
  formattedStartDate: string;
  isCurrent: boolean; // has started but not ended
  isUpcoming: boolean; // hasn't started yet
}

const activityMap = new Map<string, ActivityInfo>();

// Day name mapping
const dayNames: Record<string, string> = {
  MO: 'Mondays',
  TU: 'Tuesdays',
  WE: 'Wednesdays',
  TH: 'Thursdays',
  FR: 'Fridays',
  SA: 'Saturdays',
  SU: 'Sundays',
};

for (const activity of activities) {
  let firstDate: Temporal.ZonedDateTime | null = null;
  let lastDate: Temporal.ZonedDateTime | null = null;
  let weekday = '';
  let formattedTime = '';
  let formattedStartDate = '';

  try {
    const [first, last] = getFirstAndLastDates(
      activity.data.startDate,
      activity.data.startTime,
      activity.data.duration,
      activity.data.repeat || ''
    );
    firstDate = first;
    lastDate = last;

    // Extract weekday from repeat rule or from first date
    const repeatMatch = activity.data.repeat?.match(/BYDAY=([A-Z]{2})/);
    if (repeatMatch) {
      weekday = dayNames[repeatMatch[1]] || repeatMatch[1];
    } else if (firstDate) {
      const dayOfWeek = firstDate.toLocaleString('en-US', { weekday: 'long' });
      weekday = dayOfWeek + 's';
    }

    // Format time
    if (firstDate) {
      formattedTime = firstDate.toLocaleString('en-US', {
        hour: 'numeric',
        minute: '2-digit',
        hour12: true,
      });
      formattedStartDate = firstDate.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
      });
    }
  } catch {
    // If we can't parse dates, leave them null
  }

  const isCurrent =
    firstDate &&
    lastDate &&
    Temporal.ZonedDateTime.compare(firstDate, now) <= 0 &&
    Temporal.ZonedDateTime.compare(lastDate, now) >= 0;

  const isUpcoming = firstDate && Temporal.ZonedDateTime.compare(firstDate, now) > 0;

  activityMap.set(activity.id, {
    id: activity.id,
    name: activity.data.name,
    instructors: activity.data.instructors || [],
    startDate: activity.data.startDate,
    startTime: activity.data.startTime,
    duration: activity.data.duration,
    repeat: activity.data.repeat || '',
    firstDate,
    lastDate,
    weekday,
    formattedTime,
    formattedStartDate,
    isCurrent: !!isCurrent,
    isUpcoming: !!isUpcoming,
  });
}

// Query registrations - only paid ones
const pool = getPool();
const client = await pool.connect();

interface RegistrationRow {
  activity: string;
  student_id: number;
  firstname: string;
  lastname: string;
  dob: Date;
  contact_name: string | null;
  contact_email: string | null;
  created_at: Date;
}

let registrations: RegistrationRow[] = [];

try {
  const result = await client.query<RegistrationRow>(`
    SELECT 
      r.activity,
      r.student_id,
      s.firstname,
      s.lastname,
      s.dob,
      CONCAT(c.firstname, ' ', c.lastname) as contact_name,
      c.email as contact_email,
      r.created_at
    FROM registration r
    JOIN student s ON r.student_id = s.id
    LEFT JOIN contact c ON r.contact_id = c.id
    WHERE r.cancelled_at IS NULL
      AND r.payment_id IS NOT NULL
    ORDER BY r.activity, s.lastname, s.firstname
  `);
  registrations = result.rows;
} finally {
  client.release();
}

// Group registrations by activity
const groupedByActivity = registrations.reduce(
  (acc, reg) => {
    if (!acc.has(reg.activity)) {
      acc.set(reg.activity, []);
    }
    acc.get(reg.activity)!.push(reg);
    return acc;
  },
  new Map<string, RegistrationRow[]>()
);

// Pre-compute email lists for each activity (deduplicated by email)
const emailListsByActivity = new Map<string, { list: string; count: number }>();
for (const [activityId, regs] of groupedByActivity) {
  const uniqueContacts = new Map<string, string>();
  regs.forEach((r) => {
    if (r.contact_email) {
      const email = r.contact_email;
      if (!uniqueContacts.has(email)) {
        uniqueContacts.set(email, r.contact_name || 'Parent');
      }
    }
  });
  const emailList = Array.from(uniqueContacts.entries())
    .map(([email, name]) => `${name} <${email}>`)
    .join(', ');
  emailListsByActivity.set(activityId, { list: emailList, count: uniqueContacts.size });
}

// Separate into current and upcoming classes
const currentClasses: [string, RegistrationRow[]][] = [];
const upcomingClasses: [string, RegistrationRow[]][] = [];

for (const [activityId, regs] of groupedByActivity) {
  const activityInfo = activityMap.get(activityId);
  if (activityInfo?.isCurrent) {
    currentClasses.push([activityId, regs]);
  } else if (activityInfo?.isUpcoming) {
    upcomingClasses.push([activityId, regs]);
  } else {
    // Classes that have ended or unknown status - include in current for now
    currentClasses.push([activityId, regs]);
  }
}

// Calculate age from DOB
function calculateAge(dob: Date): number | string {
  const birthDate = new Date(dob);
  const today = new Date();
  let age = today.getFullYear() - birthDate.getFullYear();
  const monthDiff = today.getMonth() - birthDate.getMonth();
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
    age--;
  }
  return age >= 19 ? 'Adult' : age;
}

// Format date for display
function formatDate(date: Date): string {
  return new Date(date).toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
  });
}

// Get schedule string for activity
function getScheduleString(activityId: string): string {
  const info = activityMap.get(activityId);
  if (!info) return '';
  const parts = [];
  if (info.weekday) parts.push(info.weekday);
  if (info.formattedTime) parts.push(`at ${info.formattedTime}`);
  if (info.formattedStartDate) parts.push(`beginning ${info.formattedStartDate}`);
  return parts.join(' ');
}
---

<FullWidthLayout title="Ensembles - Registrations">
  <section class="registrations-page">
    <header class="page-header">
      <a href="/backstage" class="back-link">
        <Icon name="mdi:arrow-left" width="20" height="20" />
        Back to Backstage
      </a>
      <h1>Class Rosters</h1>
      <p class="subtitle">
        {registrations.length} paid registration{registrations.length !== 1 ? 's' : ''} across {groupedByActivity.size} class{groupedByActivity.size !== 1 ? 'es' : ''}
      </p>
    </header>

    {groupedByActivity.size === 0 ? (
      <div class="empty-state">
        <Icon name="mdi:clipboard-text-outline" width="64" height="64" />
        <p>No paid registrations found</p>
      </div>
    ) : (
      <>
        {/* Upcoming Classes Section */}
        {upcomingClasses.length > 0 && (
          <details class="class-section" open>
            <summary class="section-header">
              <Icon name="mdi:calendar-clock" width="24" height="24" />
              <span>Upcoming Classes</span>
              <span class="section-count">{upcomingClasses.length}</span>
            </summary>
            <div class="section-content">
              {upcomingClasses.map(([activityId, regs]) => {
                const emailData = emailListsByActivity.get(activityId)!;
                const activityInfo = activityMap.get(activityId);
                const schedule = getScheduleString(activityId);
                return (
                  <div class="class-card">
                    <div class="class-header">
                      <div class="class-title">
                        <a href={`/activities/${activityId}`}>
                          {activityInfo?.name || activityId}
                        </a>
                        <span class="student-count">{regs.length} student{regs.length !== 1 ? 's' : ''}</span>
                      </div>
                      {schedule && <p class="schedule">{schedule}</p>}
                      {emailData.count > 0 && (
                        <button
                          class="email-list-btn"
                          data-activity={activityId}
                          data-activity-name={activityInfo?.name || activityId}
                          data-emails={emailData.list}
                          title="Show email list"
                        >
                          <Icon name="mdi:email-outline" width="16" height="16" />
                          Email ({emailData.count})
                        </button>
                      )}
                    </div>
                    <ul class="student-list">
                      {regs.map((reg) => (
                        <li class="student-item">
                          <span class="student-name">{reg.firstname} {reg.lastname}</span>
                          <span class="student-age">{calculateAge(reg.dob)}</span>
                          <span class="reg-date">{formatDate(reg.created_at)}</span>
                        </li>
                      ))}
                    </ul>
                  </div>
                );
              })}
            </div>
          </details>
        )}
                {/* Current Classes Section */}
                {currentClasses.length > 0 && (
          <details class="class-section" open>
            <summary class="section-header">
              <Icon name="mdi:play-circle" width="24" height="24" />
              <span>Current Classes</span>
              <span class="section-count">{currentClasses.length}</span>
            </summary>
            <div class="section-content">
              {currentClasses.map(([activityId, regs]) => {
                const emailData = emailListsByActivity.get(activityId)!;
                const activityInfo = activityMap.get(activityId);
                const schedule = getScheduleString(activityId);
                return (
                  <div class="class-card">
                    <div class="class-header">
                      <div class="class-title">
                        <a href={`/activities/${activityId}`}>
                          {activityInfo?.name || activityId}
                        </a>
                        <span class="student-count">{regs.length} student{regs.length !== 1 ? 's' : ''}</span>
                      </div>
                      {schedule && <p class="schedule">{schedule}</p>}
                      {emailData.count > 0 && (
                        <button
                          class="email-list-btn"
                          data-activity={activityId}
                          data-activity-name={activityInfo?.name || activityId}
                          data-emails={emailData.list}
                          title="Show email list"
                        >
                          <Icon name="mdi:email-outline" width="16" height="16" />
                          Email ({emailData.count})
                        </button>
                      )}
                    </div>
                    <ul class="student-list">
                      {regs.map((reg) => (
                        <li class="student-item">
                          <span class="student-name">{reg.firstname} {reg.lastname}</span>
                          <span class="student-age">{calculateAge(reg.dob)}</span>
                          <span class="reg-date">{formatDate(reg.created_at)}</span>
                        </li>
                      ))}
                    </ul>
                  </div>
                );
              })}
            </div>
          </details>
        )}


      </>
    )}

    <!-- Email List Modal -->
    <dialog id="email-modal" class="email-modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <div class="modal-content">
        <header class="modal-header">
          <h3 id="modal-title">Email List</h3>
          <button class="close-btn" id="close-modal" aria-label="Close email list">
            <Icon name="mdi:close" width="24" height="24" />
          </button>
        </header>
        <div class="modal-body">
          <p class="modal-instructions">Copy and paste this list into your email client's "BCC" field:</p>
          <textarea id="email-list-text" readonly rows="6"></textarea>
          <button class="copy-btn" id="copy-btn">
            <Icon name="mdi:content-copy" width="18" height="18" />
            Copy to Clipboard
          </button>
          <p id="copy-feedback" class="copy-feedback"></p>
        </div>
      </div>
    </dialog>
  </section>
</FullWidthLayout>

<script>
  const modal = document.getElementById('email-modal') as HTMLDialogElement;
  const modalTitle = document.getElementById('modal-title')!;
  const emailListText = document.getElementById('email-list-text') as HTMLTextAreaElement;
  const copyBtn = document.getElementById('copy-btn')!;
  const closeBtn = document.getElementById('close-modal')!;
  const copyFeedback = document.getElementById('copy-feedback')!;

  // Open modal when email list button is clicked
  document.querySelectorAll('.email-list-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      const activityName = btn.getAttribute('data-activity-name') || 'Class';
      const emails = btn.getAttribute('data-emails') || '';

      modalTitle.textContent = `Email List - ${activityName}`;
      emailListText.value = emails;
      copyFeedback.textContent = '';
      modal.showModal();
    });
  });

  // Close modal
  closeBtn.addEventListener('click', () => modal.close());
  modal.addEventListener('click', (e) => {
    if (e.target === modal) modal.close();
  });

  // Copy to clipboard
  copyBtn.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(emailListText.value);
      copyFeedback.textContent = '✓ Copied to clipboard!';
      copyFeedback.className = 'copy-feedback success';
    } catch {
      // Fallback for older browsers
      emailListText.select();
      document.execCommand('copy');
      copyFeedback.textContent = '✓ Copied to clipboard!';
      copyFeedback.className = 'copy-feedback success';
    }
  });
</script>

<style>
  .registrations-page {
    max-width: 800px;
    margin: 0 auto;
    padding: 1.5rem 1rem;
  }

  .page-header {
    margin-bottom: 1.5rem;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: #666;
    text-decoration: none;
    font-size: 0.9rem;
    margin-bottom: 0.75rem;
  }

  .back-link:hover {
    color: #333;
  }

  .page-header h1 {
    margin: 0 0 0.25rem;
    font-size: 1.5rem;
  }

  .subtitle {
    color: #666;
    margin: 0;
    font-size: 0.9rem;
  }

  .empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: #999;
  }

  .empty-state p {
    margin-top: 1rem;
    font-size: 1rem;
  }

  /* Section Styles */
  .class-section {
    margin-bottom: 1.5rem;
    background: white;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }

  .section-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem;
    background: #f8f9fa;
    cursor: pointer;
    font-weight: 600;
    font-size: 1rem;
    list-style: none;
    border-bottom: 1px solid #e5e7eb;
  }

  .section-header::-webkit-details-marker {
    display: none;
  }

  .section-header::before {
    content: '▶';
    font-size: 0.7rem;
    transition: transform 0.2s;
    color: #666;
  }

  details[open] .section-header::before {
    transform: rotate(90deg);
  }

  .section-count {
    margin-left: auto;
    background: #e5e5e5;
    color: #666;
    padding: 0.125rem 0.5rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
  }

  .section-content {
    padding: 0.5rem;
  }

  /* Class Card Styles */
  .class-card {
    background: #fafafa;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    overflow: hidden;
  }

  .class-card:last-child {
    margin-bottom: 0;
  }

  .class-header {
    padding: 0.75rem 1rem;
    background: white;
    border-bottom: 1px solid #eee;
  }

  .class-title {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 0.25rem;
  }

  .class-title a {
    color: #1a56db;
    text-decoration: none;
    font-weight: 600;
    font-size: 1rem;
  }

  .class-title a:hover {
    text-decoration: underline;
  }

  .student-count {
    font-size: 0.8rem;
    color: #666;
    font-weight: normal;
  }

  .schedule {
    margin: 0;
    font-size: 0.85rem;
    color: #555;
  }

  .email-list-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    margin-top: 0.5rem;
    padding: 0.375rem 0.625rem;
    background: #3b82f6;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.15s;
  }

  .email-list-btn:hover {
    background: #2563eb;
  }

  /* Student List Styles */
  .student-list {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .student-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1rem;
    border-bottom: 1px solid #eee;
    font-size: 0.9rem;
  }

  .student-item:last-child {
    border-bottom: none;
  }

  .student-name {
    flex: 1;
    font-weight: 500;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .student-age {
    flex-shrink: 0;
    background: #e5e7eb;
    color: #555;
    padding: 0.125rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    min-width: 40px;
    text-align: center;
  }

  .reg-date {
    flex-shrink: 0;
    color: #888;
    font-size: 0.75rem;
    min-width: 50px;
    text-align: right;
  }

  /* Modal Styles */
  .email-modal {
    border: none;
    border-radius: 12px;
    padding: 0;
    max-width: 500px;
    width: 90vw;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  }

  .email-modal::backdrop {
    background: rgba(0, 0, 0, 0.5);
  }

  .modal-content {
    padding: 0;
  }

  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
  }

  .modal-header h3 {
    margin: 0;
    font-size: 1rem;
  }

  .close-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    background: none;
    border: none;
    color: #666;
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 4px;
  }

  .close-btn:hover {
    background: #f3f4f6;
    color: #333;
  }

  .modal-body {
    padding: 1rem;
  }

  .modal-instructions {
    margin: 0 0 0.75rem;
    color: #666;
    font-size: 0.85rem;
  }

  #email-list-text {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-family: inherit;
    font-size: 0.8rem;
    resize: vertical;
    background: #f9fafb;
  }

  #email-list-text:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .copy-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.75rem;
    padding: 0.5rem 1rem;
    background: #10b981;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.15s;
  }

  .copy-btn:hover {
    background: #059669;
  }

  .copy-feedback {
    margin: 0.5rem 0 0;
    font-size: 0.8rem;
    min-height: 1.25rem;
  }

  .copy-feedback.success {
    color: #059669;
  }

  /* Mobile optimization */
  @media (max-width: 480px) {
    .registrations-page {
      padding: 1rem 0.75rem;
    }

    .page-header h1 {
      font-size: 1.25rem;
    }

    .section-header {
      padding: 0.75rem;
      font-size: 0.9rem;
    }

    .class-header {
      padding: 0.625rem 0.75rem;
    }

    .class-title a {
      font-size: 0.9rem;
    }

    .schedule {
      font-size: 0.8rem;
    }

    .student-item {
      padding: 0.5rem 0.75rem;
      font-size: 0.85rem;
    }

    .student-age {
      font-size: 0.7rem;
      padding: 0.1rem 0.375rem;
      min-width: 36px;
    }

    .reg-date {
      font-size: 0.7rem;
    }
  }
</style>
