---
export const prerender = false;

import FullWidthLayout from '../../layouts/FullWidthLayout.astro';
import { getPool } from '../../lib/db';
import { getCollection } from 'astro:content';
import { Icon } from 'astro-icon/components';

// Get all activities to map IDs to names
const activities = await getCollection('activities');
const activityMap = new Map(activities.map(a => [a.id, a.data.name]));

// Query registrations grouped by activity
const pool = getPool();
const client = await pool.connect();

interface RegistrationRow {
  activity: string;
  student_id: number;
  firstname: string;
  lastname: string;
  dob: Date;
  contact_name: string | null;
  contact_email: string | null;
  contact_phone: string | null;
  payment_id: number | null;
  cost: number | null;
  created_at: Date;
}

let registrations: RegistrationRow[] = [];

try {
  const result = await client.query<RegistrationRow>(`
    SELECT 
      r.activity,
      r.student_id,
      s.firstname,
      s.lastname,
      s.dob,
      CONCAT(c.firstname, ' ', c.lastname) as contact_name,
      c.email as contact_email,
      c.phone as contact_phone,
      r.payment_id,
      r.cost,
      r.created_at
    FROM registration r
    JOIN student s ON r.student_id = s.id
    LEFT JOIN contact c ON r.contact_id = c.id
    WHERE r.cancelled_at IS NULL
    ORDER BY r.activity, s.lastname, s.firstname
  `);
  registrations = result.rows;
} finally {
  client.release();
}

// Group registrations by activity
const groupedByActivity = registrations.reduce((acc, reg) => {
  if (!acc.has(reg.activity)) {
    acc.set(reg.activity, []);
  }
  acc.get(reg.activity)!.push(reg);
  return acc;
}, new Map<string, RegistrationRow[]>());

// Pre-compute email lists for each activity (paid registrations only, deduplicated)
const emailListsByActivity = new Map<string, { list: string; count: number }>();
for (const [activityId, regs] of groupedByActivity) {
  const paidRegs = regs.filter(r => r.payment_id && r.contact_email);
  const uniqueContacts = new Map<string, string>();
  paidRegs.forEach(r => {
    if (!uniqueContacts.has(r.contact_email!)) {
      uniqueContacts.set(r.contact_email!, r.contact_name || 'Parent');
    }
  });
  const emailList = Array.from(uniqueContacts.entries())
    .map(([email, name]) => `${name} <${email}>`)
    .join(', ');
  emailListsByActivity.set(activityId, { list: emailList, count: uniqueContacts.size });
}

// Format date for display
function formatDate(date: Date): string {
  return new Date(date).toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric'
  });
}

function formatDob(date: Date): string {
  return new Date(date).toLocaleDateString('en-US', {
    month: '2-digit',
    day: '2-digit',
    year: 'numeric'
  });
}
---

<FullWidthLayout title="Ensembles - Registrations">
  <section class="registrations-page">
    <header class="page-header">
      <a href="/backstage" class="back-link">
        <Icon name="mdi:arrow-left" width="20" height="20" />
        Back to Backstage
      </a>
      <h1>Registrations</h1>
      <p class="subtitle">
        {registrations.length} student{registrations.length !== 1 ? 's' : ''} registered across {groupedByActivity.size} activit{groupedByActivity.size !== 1 ? 'ies' : 'y'}
      </p>
    </header>

    {groupedByActivity.size === 0 ? (
      <div class="empty-state">
        <Icon name="mdi:clipboard-text-outline" width="64" height="64" />
        <p>No registrations found</p>
      </div>
    ) : (
      Array.from(groupedByActivity.entries()).map(([activityId, regs]) => {
        const emailData = emailListsByActivity.get(activityId)!;
        return (
        <div class="activity-section">
          <h2>
            <a href={`/activities/${activityId}`}>
              {activityMap.get(activityId) || activityId}
            </a>
            <span class="count">{regs.length}</span>
            {emailData.count > 0 && (
              <button 
                class="email-list-btn" 
                data-activity={activityId}
                data-emails={emailData.list}
                title="Show email list for paid registrations"
              >
                <Icon name="mdi:email-outline" width="18" height="18" />
                Email List ({emailData.count})
              </button>
            )}
          </h2>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Student Name</th>
                  <th>DOB</th>
                  <th>Contact</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Status</th>
                  <th>Registered</th>
                </tr>
              </thead>
              <tbody>
                {regs.map((reg) => (
                  <tr class={reg.payment_id ? 'paid' : 'pending'}>
                    <td class="student-name">{reg.firstname} {reg.lastname}</td>
                    <td class="dob">{formatDob(reg.dob)}</td>
                    <td>{reg.contact_name || '—'}</td>
                    <td class="email">{reg.contact_email || '—'}</td>
                    <td class="phone">{reg.contact_phone || '—'}</td>
                    <td class="status">
                      {reg.payment_id ? (
                        <span class="badge paid">
                          <Icon name="mdi:check-circle" width="16" height="16" />
                          Paid
                        </span>
                      ) : (
                        <span class="badge pending">
                          <Icon name="mdi:clock-outline" width="16" height="16" />
                          Pending
                        </span>
                      )}
                    </td>
                    <td class="date">{formatDate(reg.created_at)}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )})
    )}

    <!-- Email List Modal -->
    <dialog id="email-modal" class="email-modal">
      <div class="modal-content">
        <header class="modal-header">
          <h3 id="modal-title">Email List</h3>
          <button class="close-btn" id="close-modal">
            <Icon name="mdi:close" width="24" height="24" />
          </button>
        </header>
        <div class="modal-body">
          <p class="modal-instructions">Copy and paste this list into your email client's "BCC" field:</p>
          <textarea id="email-list-text" readonly rows="6"></textarea>
          <button class="copy-btn" id="copy-btn">
            <Icon name="mdi:content-copy" width="18" height="18" />
            Copy to Clipboard
          </button>
          <p id="copy-feedback" class="copy-feedback"></p>
        </div>
      </div>
    </dialog>
  </section>
</FullWidthLayout>

<script>
  const modal = document.getElementById('email-modal') as HTMLDialogElement;
  const modalTitle = document.getElementById('modal-title')!;
  const emailListText = document.getElementById('email-list-text') as HTMLTextAreaElement;
  const copyBtn = document.getElementById('copy-btn')!;
  const closeBtn = document.getElementById('close-modal')!;
  const copyFeedback = document.getElementById('copy-feedback')!;

  // Open modal when email list button is clicked
  document.querySelectorAll('.email-list-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const activityId = btn.getAttribute('data-activity');
      const emails = btn.getAttribute('data-emails') || '';
      
      modalTitle.textContent = `Email List - ${activityId}`;
      emailListText.value = emails;
      copyFeedback.textContent = '';
      modal.showModal();
    });
  });

  // Close modal
  closeBtn.addEventListener('click', () => modal.close());
  modal.addEventListener('click', (e) => {
    if (e.target === modal) modal.close();
  });

  // Copy to clipboard
  copyBtn.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(emailListText.value);
      copyFeedback.textContent = '✓ Copied to clipboard!';
      copyFeedback.className = 'copy-feedback success';
    } catch (err) {
      // Fallback for older browsers
      emailListText.select();
      document.execCommand('copy');
      copyFeedback.textContent = '✓ Copied to clipboard!';
      copyFeedback.className = 'copy-feedback success';
    }
  });
</script>

<style>
  .registrations-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  .page-header {
    margin-bottom: 2rem;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: #666;
    text-decoration: none;
    font-size: 0.9rem;
    margin-bottom: 1rem;
  }

  .back-link:hover {
    color: #333;
  }

  .page-header h1 {
    margin-bottom: 0.5rem;
  }

  .subtitle {
    color: #666;
    margin: 0;
  }

  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: #999;
  }

  .empty-state p {
    margin-top: 1rem;
    font-size: 1.1rem;
  }

  .activity-section {
    margin-bottom: 2.5rem;
  }

  .activity-section h2 {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
    font-size: 1.25rem;
  }

  .activity-section h2 a {
    color: inherit;
    text-decoration: none;
  }

  .activity-section h2 a:hover {
    text-decoration: underline;
  }

  .count {
    background: #e5e5e5;
    color: #666;
    padding: 0.125rem 0.5rem;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 500;
  }

  .table-wrapper {
    overflow-x: auto;
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }

  th, td {
    padding: 0.75rem 1rem;
    text-align: left;
    border-bottom: 1px solid #eee;
  }

  th {
    background: #f8f9fa;
    font-weight: 600;
    color: #555;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }

  tbody tr:hover {
    background: #fafafa;
  }

  tbody tr:last-child td {
    border-bottom: none;
  }

  .student-name {
    font-weight: 500;
  }

  .dob, .date {
    white-space: nowrap;
    color: #666;
  }

  .email {
    font-size: 0.85rem;
  }

  .phone {
    white-space: nowrap;
  }

  .status {
    white-space: nowrap;
  }

  .badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 500;
  }

  .badge.paid {
    background: #dcfce7;
    color: #166534;
  }

  .badge.pending {
    background: #fef3c7;
    color: #92400e;
  }

  .email-list-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    margin-left: auto;
    padding: 0.375rem 0.75rem;
    background: #3b82f6;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.15s;
  }

  .email-list-btn:hover {
    background: #2563eb;
  }

  /* Modal Styles */
  .email-modal {
    border: none;
    border-radius: 12px;
    padding: 0;
    max-width: 600px;
    width: 90vw;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  }

  .email-modal::backdrop {
    background: rgba(0, 0, 0, 0.5);
  }

  .modal-content {
    padding: 0;
  }

  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #e5e7eb;
  }

  .modal-header h3 {
    margin: 0;
    font-size: 1.1rem;
  }

  .close-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    background: none;
    border: none;
    color: #666;
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 4px;
  }

  .close-btn:hover {
    background: #f3f4f6;
    color: #333;
  }

  .modal-body {
    padding: 1.25rem;
  }

  .modal-instructions {
    margin: 0 0 0.75rem;
    color: #666;
    font-size: 0.9rem;
  }

  #email-list-text {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-family: inherit;
    font-size: 0.85rem;
    resize: vertical;
    background: #f9fafb;
  }

  #email-list-text:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .copy-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1rem;
    padding: 0.5rem 1rem;
    background: #10b981;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.15s;
  }

  .copy-btn:hover {
    background: #059669;
  }

  .copy-feedback {
    margin: 0.5rem 0 0;
    font-size: 0.85rem;
    min-height: 1.25rem;
  }

  .copy-feedback.success {
    color: #059669;
  }

  @media (max-width: 768px) {
    .registrations-page {
      padding: 1rem;
    }

    th, td {
      padding: 0.5rem;
      font-size: 0.8rem;
    }

    .email {
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  }
</style>

