---
export const prerender = true;

import Layout from '../../layouts/Layout.astro';
import { Icon } from 'astro-icon/components';
---

<Layout title="Ensembles - RRule Tester">
  <main>
    <h1><Icon name="mdi:test-tube" /> Repeating Event Generator</h1>
    <p>Test your event repeat rules to see when events will occur.</p>

    <div class="container">
      <div class="left-column">
        <form id="rrule-form">
          <div class="form-group">
            <label for="startDate">startDate:</label>
            <input
              type="text"
              id="startDate"
              name="startDate"
              placeholder="MM/DD/YYYY"
              required
            />
          </div>

          <div class="form-group">
            <label for="startTime">startTime:</label>
            <input
              type="text"
              id="startTime"
              name="startTime"
              placeholder="HH:MM (am/pm)"
              required
            />
          </div>

          <div class="form-group">
            <label for="duration">duration:</label>
            <input
              type="text"
              id="duration"
              name="duration"
              placeholder="minutes or HH:MM or 1h30m"
              required
            />
          </div>

          <div class="form-group">
            <label for="repeat">repeat:</label>
            <input
              type="text"
              id="repeat"
              name="repeat"
            />
            <small>Click an example to use it:
              <ul class="examples-list">
                <li>
                  <button type="button" class="example-btn" data-rrule="FREQ=WEEKLY;COUNT=6;BYDAY=TU">
                    6-week class every Tuesday
                  </button>
                </li>
                <li>
                  <button type="button" class="example-btn" data-start-date="11/4/2025" data-rrule="FREQ=WEEKLY;COUNT=6;BYDAY=TU;EXDATE=11/25/2025">
                    6-week session with 1 week break
                  </button>
                </li>
                <li>
                  <button type="button" class="example-btn" data-rrule=" ">
                    One time event
                  </button>
                </li>
                <li>
                  <button type="button" class="example-btn" data-start-date="8/29/2025" data-rrule="FREQ=WEEKLY;UNTIL=10/10/2025;EXDATE=9/12/2025,10/3/2025">
                    5 Friday nights
                  </button>
                </li>
              </ul>
            </small>
          </div>

          <button type="submit">Generate Occurrences</button>
        </form>
      </div>

      <div class="right-column">
        <div id="results" style="display: none;">
          <h2>Results</h2>
          
          <div id="text-description-container">
            <p>&ldquo;<span id="text-description"></span>&rdquo;</p>
          </div>

          <div id="occurrences-container">
            <h3>Event Occurrences:</h3>
            <div id="occurrence-count"></div>
            <ul id="occurrences-list"></ul>
          </div>

          <div id="error-container" style="display: none;">
            <h3>Error:</h3>
            <pre id="error-message"></pre>
          </div>

          <div id="rrule-string-container">
            <h3>Generated RRule String:</h3>
            <pre id="rrule-string"></pre>
          </div>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  import { RRuleTemporal } from 'rrule-temporal';
  import { toText } from 'rrule-temporal/totext';
  import {
    buildRRuleString,
  } from '../../lib/datelib';

  const form = document.getElementById('rrule-form') as HTMLFormElement;
  const resultsDiv = document.getElementById('results') as HTMLDivElement;
  const textDescription = document.getElementById('text-description') as HTMLParagraphElement;
  const rruleStringPre = document.getElementById('rrule-string') as HTMLPreElement;
  const occurrencesList = document.getElementById('occurrences-list') as HTMLUListElement;
  const occurrenceCount = document.getElementById('occurrence-count') as HTMLDivElement;
  const errorContainer = document.getElementById('error-container') as HTMLDivElement;
  const errorMessage = document.getElementById('error-message') as HTMLPreElement;
  const repeatInput = document.getElementById('repeat') as HTMLInputElement;
  const startDateInput = document.getElementById('startDate') as HTMLInputElement;

  // Handle example button clicks
  const exampleButtons = document.querySelectorAll('.example-btn');
  exampleButtons.forEach(button => {
    button.addEventListener('click', () => {
      const startDate = button.getAttribute('data-start-date'); 
      if (startDate) {
        startDateInput.value = startDate;
      }
      const rrule = button.getAttribute('data-rrule');
      if (rrule) {
        repeatInput.value = rrule;
        repeatInput.focus();
      }
    });
  });

  form.addEventListener('submit', (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const startDate = formData.get('startDate') as string;
    const startTime = formData.get('startTime') as string;
    const duration = formData.get('duration') as string;
    const repeat = formData.get('repeat') as string;

    try {
      // Build the RRule string
      const rruleString = buildRRuleString(startDate, startTime, duration, repeat);
      
      // Display the RRule string
      rruleStringPre.textContent = rruleString;

      // Parse with RRuleTemporal
      const rruleTemporal = new RRuleTemporal({ rruleString });
      
      // Display the human-readable text
      textDescription.textContent = toText(rruleString);
      
      // Get all occurrences (limit to 100 for safety)
      const occurrences = rruleTemporal.all((dt, i) => i < 100);

      // Clear previous results
      occurrencesList.innerHTML = '';
      errorContainer.style.display = 'none';

      // Display count
      const total = occurrences.length;
      occurrenceCount.textContent = `Total occurrences: ${occurrences.length}${occurrences.length >= 100 ? ' (limited to first 100)' : ''}${total !== null && total !== occurrences.length ? ` of ${total}` : ''}`;

      // Display each occurrence
      occurrences.forEach((dt, index) => {
        const li = document.createElement('li');
        const dateStr = dt.toLocaleString('en-US', {
          dateStyle: 'full',
          timeStyle: 'short',
        });
        li.textContent = `${index + 1}. ${dateStr}`;
        occurrencesList.appendChild(li);
      });

      // Show results
      resultsDiv.style.display = 'block';
      
      // Scroll results into view
      resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } catch (error) {
      // Show error
      errorMessage.textContent = error instanceof Error ? error.message : String(error);
      errorContainer.style.display = 'block';
      resultsDiv.style.display = 'block';
      
      // Scroll results into view
      resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  });
</script>

<style>
  main {
    max-width: 1400px;
    margin: 2rem auto;
    padding: 0 1rem;
  }

  h1 {
    color: #333;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  h2 {
    color: #333;
    margin-top: 0;
    margin-bottom: 1rem;
  }

  h3 {
    color: #555;
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .container {
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;
    margin-top: 2rem;
  }

  @media (min-width: 1024px) {
    .container {
      grid-template-columns: 450px 1fr;
      align-items: start;
    }
  }

  .left-column {
    position: relative;
  }

  @media (min-width: 1024px) {
    .left-column {
      position: sticky;
      top: 2rem;
    }
  }

  .right-column {
    min-height: 200px;
  }

  form {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #333;
  }

  input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
    font-family: inherit;
  }

  input:focus {
    outline: none;
    border-color: #4a90e2;
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
  }

  small {
    display: block;
    margin-top: 0.5rem;
    color: #666;
    font-size: 0.875rem;
  }

  small ul {
    margin: 0.5rem 0 0 0;
    padding-left: 0;
  }

  small li {
    margin: 0.25rem 0;
  }

  .examples-list {
    list-style: none;
  }

  .example-btn {
    background: #f5f5f5;
    color: #4a90e2;
    padding: 0.4rem 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s;
    font-family: inherit;
  }

  .example-btn:hover {
    background: #4a90e2;
    color: white;
    border-color: #4a90e2;
  }

  .example-btn:active {
    transform: scale(0.98);
  }

  code {
    background: #f5f5f5;
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
  }

  button {
    background: #4a90e2;
    color: white;
    padding: 0.75rem 2rem;
    border: none;
    border-radius: 4px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }

  button:hover {
    background: #357abd;
  }

  #results {
    margin-top: 2rem;
  }

  #text-description-container,
  #rrule-string-container,
  #occurrences-container,
  #error-container {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    margin-bottom: 1.5rem;
  }

  #text-description {
    font-size: 1.1rem;
    color: #333;
    font-weight: 500;
    margin: 0;
  }

  pre {
    background: #f5f5f5;
    padding: 1rem;
    border-radius: 4px;
    overflow-x: auto;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    line-height: 1.5;
  }

  #error-container {
    background: #fff5f5;
    border-left: 4px solid #e53e3e;
  }

  #error-message {
    background: white;
    color: #c53030;
  }

  #occurrence-count {
    font-weight: 600;
    color: #333;
    margin-bottom: 1rem;
    padding: 0.5rem;
    background: #f0f7ff;
    border-radius: 4px;
  }

  #occurrences-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  #occurrences-list li {
    padding: 0.75rem;
    border-bottom: 1px solid #eee;
  }

  #occurrences-list li:last-child {
    border-bottom: none;
  }

  #occurrences-list li:hover {
    background: #f9f9f9;
  }
</style>

