---
import { getCollection, render } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import FullWidthLayout from '../layouts/FullWidthLayout.astro';
import ActivityCard from '../components/ActivityCard.astro';
import { Temporal } from '@js-temporal/polyfill';
import { getHourAndMinute } from '../lib/datelib';

const activities = await getCollection('activities');

// Render markdown content for each event
const renderedActivities = await Promise.all(
  activities
    .sort((a, b) => {
      const [monthA, dayA, yearA] = a.data.startDate.split('/').map(Number);
      const [monthB, dayB, yearB] = b.data.startDate.split('/').map(Number);
      const startTimeA = getHourAndMinute(a.data.startTime);
      const startTimeB = getHourAndMinute(b.data.startTime);
      // Include start time in comparison by creating a PlainDateTime with hours and minutes
      const dateA = Temporal.PlainDateTime.from({
        year: yearA,
        month: monthA,
        day: dayA,
        ...startTimeA,
      });
      const dateB = Temporal.PlainDateTime.from({
        year: yearB,
        month: monthB,
        day: dayB,
        ...startTimeB,
      });
      return Temporal.PlainDateTime.compare(dateA, dateB);
    })
    .map(async (activity: CollectionEntry<'activities'>) => {
    const { Content } = await render(activity);
    return {
      ...activity,
      Content
    };
  })
);
---


<FullWidthLayout>
  <section class="activities-section">
    <h1>Activities</h1>
    <div class="toggle-group">
      <button type="button" class="toggle-btn active" data-filter="current">Current</button>
      <button type="button" class="toggle-btn" data-filter="upcoming">Upcoming</button>
    </div>
    <div class="activities-grid">
      {renderedActivities.map((activity) => (
        <ActivityCard
          activityId={activity.id}
          name={activity.data.name}
          image={activity.data.image}
          startDate={activity.data.startDate}
          startTime={activity.data.startTime}
          duration={activity.data.duration}
          repeat={activity.data.repeat}
          ageMin={activity.data.ageMin}
          ageMax={activity.data.ageMax}
          cost={activity.data.cost}
          instructors={activity.data.instructors}
        >
          <activity.Content />
        </ActivityCard>
      ))}
    </div>
  </section>
</FullWidthLayout>

<script>
  const today = Math.floor(Date.now() / 1000);
  const toggleButtons = document.querySelectorAll('.toggle-btn');
  const cards = document.querySelectorAll('.activity-card');

  function filterCards(filter: string) {
    cards.forEach((card) => {
      const startDate = parseInt(card.getAttribute('data-start') || '0', 10);
      const isCurrent = startDate < today;
      const isUpcoming = startDate >= today;

      if (filter === 'current') {
        (card as HTMLElement).style.display = isCurrent ? '' : 'none';
      } else {
        (card as HTMLElement).style.display = isUpcoming ? '' : 'none';
      }
    });
  }

  toggleButtons.forEach((btn) => {
    btn.addEventListener('click', () => {
      toggleButtons.forEach((b) => b.classList.remove('active'));
      btn.classList.add('active');
      const filter = btn.getAttribute('data-filter') || 'current';
      filterCards(filter);
    });
  });

  // Initial filter
  filterCards('current');
</script>

<style>
  .activities-section {
    padding: 2rem;
  }

  h1 {
    margin-bottom: 1.5rem;
    font-size: 2.5rem;
    color: #333;
    padding: 0 1rem;
  }

  .toggle-group {
    display: flex;
    justify-content: center;
    gap: 0;
    margin-bottom: 2rem;
  }

  .toggle-btn {
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
    font-weight: 600;
    border: 2px solid var(--color-button-primary-background);
    background: var(--color-button-secondary-background);
    color: var(--color-button-secondary-text);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .toggle-btn:first-child {
    border-radius: 6px 0 0 6px;
    border-right: 1px solid var(--color-button-primary-background);
  }

  .toggle-btn:last-child {
    border-radius: 0 6px 6px 0;
    border-left: 1px solid var(--color-button-primary-background);
  }

  .toggle-btn:hover:not(.active) {
    background: var(--color-button-secondary-hover-background);
  }

  .toggle-btn.active {
    background: var(--color-button-primary-background);
    color: var(--color-button-primary-text);
  }

  .activities-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, 320px);
    gap: 2rem;
    padding: 0 1rem;
    justify-content: center;
  }

  /* Responsive breakpoints */
  @media (max-width: 768px) {
    .activities-section {
      padding: 1rem;
    }

    .activities-grid {
      grid-template-columns: 320px;
      padding: 0;
      justify-content: center;
    }

    h1 {
      font-size: 2rem;
      padding: 0;
      text-align: center;
    }

    .toggle-btn {
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
    }
  }
</style> 