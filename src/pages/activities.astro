---
import { getCollection } from 'astro:content';
import FullWidthLayout from '../layouts/FullWidthLayout.astro';
import ActivityCard from '../components/ActivityCard.astro';
import { Temporal } from '@js-temporal/polyfill';
import { getHourAndMinute } from '../lib/datelib';
import { Icon } from 'astro-icon/components';

const activities = await getCollection('activities');

// Sort activities by start date/time
const sortedActivities = activities.sort((a, b) => {
  const [monthA, dayA, yearA] = a.data.startDate.split('/').map(Number);
  const [monthB, dayB, yearB] = b.data.startDate.split('/').map(Number);
  const startTimeA = getHourAndMinute(a.data.startTime);
  const startTimeB = getHourAndMinute(b.data.startTime);
  const dateA = Temporal.PlainDateTime.from({
    year: yearA,
    month: monthA,
    day: dayA,
    ...startTimeA,
  });
  const dateB = Temporal.PlainDateTime.from({
    year: yearB,
    month: monthB,
    day: dayB,
    ...startTimeB,
  });
  return Temporal.PlainDateTime.compare(dateA, dateB);
});
---


<FullWidthLayout title="Ensembles - Activities">
  {/* Hidden icon sprite definitions - prevents symbols from being removed with cards */}
  <div class="icon-sprites" aria-hidden="true">
    <Icon name="mdi:calendar" width="16" height="16" />
    <Icon name="mdi:access-time" width="16" height="16" />
    <Icon name="mdi:calendar-repeat" width="16" height="16" />
  </div>

  <section class="activities-section">
    <h1 id="page-title">Activities</h1>
    <a href="/activities" id="show-all-link" class="show-all-link" hidden>Show all activities &rarr;</a>
      <details class="activity-group">
        <summary>
          <span class="summary-text">Happening now</span>
          <span class="summary-count current">--</span>
        </summary>
        <div class="activities-grid current">
          {sortedActivities.map((activity) => (
            <ActivityCard
              activityId={activity.id}
              name={activity.data.name}
              image={activity.data.image}
              startDate={activity.data.startDate}
              startTime={activity.data.startTime}
              duration={activity.data.duration}
              repeat={activity.data.repeat}
              ageMin={activity.data.ageMin}
              ageMax={activity.data.ageMax}
              cost={activity.data.cost}
              instructors={activity.data.instructors}
              sizeMax={activity.data.sizeMax}
              kind={activity.data.kind}
            />
          ))}
        </div>
      </details>

      <details class="activity-group" open>
        <summary>
          <span class="summary-text">Upcoming</span>
          <span class="summary-count upcoming">--</span>
        </summary>
        <div class="activities-grid upcoming">
          <p class="placeholder">Check back soon for upcoming <span class="kind-word">activities</span>, or <a href="/activities" class="show-all-link">Show all activities</a>.</p>
        </div>
      </details>
  </section>
</FullWidthLayout>

<style>
  /* Hidden sprite container for icon symbol definitions */
  .icon-sprites {
    position: absolute;
    width: 0;
    height: 0;
    overflow: hidden;
  }

  .activities-section {
    padding: 2rem;
  }

  h1 {
    margin-bottom: 0.5rem;
    font-size: 2.5rem;
    color: #333;
    padding: 0 1rem;
  }

  .show-all-link {
    display: block;
    padding: 0 1rem;
    margin-bottom: 1rem;
    color: #2563eb;
    text-decoration: none;
    font-size: 0.95rem;
  }

  .show-all-link:hover {
    text-decoration: underline;
  }

  .show-all-link[hidden] {
    display: none;
  }

  .activity-group {
    margin-bottom: 2rem;
  }

  .activity-group summary {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    font-size: 1.25rem;
    font-weight: 600;
    color: #333;
    cursor: pointer;
    list-style: none;
    border-bottom: 2px solid #eee;
    margin-bottom: 1.5rem;
  }

  .activity-group summary::-webkit-details-marker {
    display: none;
  }

  .activity-group summary::before {
    content: 'â–¶';
    font-size: 0.75rem;
    transition: transform 0.2s ease;
  }

  .activity-group[open] summary::before {
    transform: rotate(90deg);
  }

  .activity-group summary:hover {
    background: #f9f9f9;
  }

  .summary-text {
    flex: 1;
  }

  .summary-count {
    background: #eee;
    color: #666;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.875rem;
    font-weight: 500;
  }

  .activities-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, 320px);
    gap: 2rem;
    padding: 0 1rem;
    justify-content: center;
  }

  /* Responsive breakpoints */
  @media (max-width: 768px) {
    .activities-section {
      padding: 1rem;
    }

    .activities-grid {
      grid-template-columns: 320px;
      padding: 0;
      justify-content: center;
    }

    h1 {
      font-size: 2rem;
      padding: 0;
      text-align: center;
    }

    .activity-group summary {
      font-size: 1.1rem;
      padding: 0.75rem;
    }
  }

  /* Hide sections with no activities */
  .activity-group.empty {
    display: none;
  }

  .activities-grid .placeholder {
    grid-column: 1 / -1;
    text-align: center;
    color: #666;
    padding: 2rem;
  }
</style>

<script>
  interface ActivityStatus {
    activityId: string;
    kind: string;
    registeredCount: number;
    sizeMax: number | null;
    isFull: boolean;
    spotsRemaining: number | null;
  }

  function categorizeActivities(): string[] {
    const now = Math.floor(Date.now() / 1000); // Current time in seconds
    const cards = document.querySelectorAll('.activity-card');
    const currentGrid = document.querySelector('.activities-grid.current');
    const upcomingGrid = document.querySelector('.activities-grid.upcoming');
    const currentCount = document.querySelector('.summary-count.current');
    const upcomingCount = document.querySelector('.summary-count.upcoming');
    const currentGroup = currentGrid?.closest('.activity-group');
    const upcomingGroup = upcomingGrid?.closest('.activity-group');
    const placeholder = upcomingGrid?.querySelector('.placeholder');

    // Check for kind filter in URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const kindFilter = urlParams.get('kind');

    // Update title and show "Show all" link if filtering by kind
    if (kindFilter) {
      const pageTitle = document.getElementById('page-title');
      const kindWords = document.querySelectorAll('.kind-word');
      const showAllLink = document.getElementById('show-all-link');
      const kindTitles: Record<string, string> = {
        class: 'Classes',
        group: 'Groups',
        event: 'Events',
      };
      if (pageTitle && kindTitles[kindFilter]) {
        pageTitle.textContent = kindTitles[kindFilter];
      }
      if (kindWords) {
        kindWords.forEach(word => {
          word.textContent = kindTitles[kindFilter] || 'activities';
        });
      }
      if (showAllLink) {
        showAllLink.hidden = false;
      }
    }

    if (!currentGrid || !upcomingGrid) return [];

    let currentActivities = 0;
    let upcomingActivities = 0;
    const upcomingIds: string[] = [];

    cards.forEach(card => {
      const startTime = parseInt(card.getAttribute('data-start') || '0', 10);
      const endTime = parseInt(card.getAttribute('data-end') || '0', 10);
      const cardKind = card.getAttribute('data-kind');

      // Filter by kind if specified in URL
      if (kindFilter && cardKind !== kindFilter) {
        card.remove();
        return;
      }

      if (endTime < now) {
        // Activity has ended - remove it
        card.remove();
      } else if (startTime > now || cardKind === 'group') {
        // Activity Available for registration - move to upcoming
        upcomingGrid.appendChild(card);
        card.classList.add('upcoming');
        upcomingActivities++;
        upcomingIds.push(card.id);
      } else {
        // Activity is currently running - keep in current
        card.classList.add('current');
        currentActivities++;
      }
    });

    // Update counts
    if (currentCount) {
      currentCount.textContent = currentActivities.toString();
    }
    if (upcomingCount) {
      upcomingCount.textContent = upcomingActivities.toString();
    }

    // Hide empty sections
    if (currentActivities === 0 && currentGroup) {
      currentGroup.classList.add('empty');
    }
    if (upcomingActivities === 0 && upcomingGroup) {
      // Keep placeholder visible if no upcoming activities
      if (placeholder instanceof HTMLElement) {
        placeholder.style.display = 'block';
      }
    } else if (placeholder) {
      // Remove placeholder if there are upcoming activities
      placeholder.remove();
    }

    // Open the section that has activities
    if (upcomingActivities == 0 && currentGroup) {
      (currentGroup as HTMLDetailsElement).open = true;
    }
    if (upcomingGroup) {
      (upcomingGroup as HTMLDetailsElement).open = true;
    }

    return upcomingIds;
  }

  async function updateRegistrationStatus(activityIds: string[]) {
    if (activityIds.length === 0) return;

    try {
      const url = '/api/activity-status?' + activityIds.map(id => 'id=' + encodeURIComponent(id)).join('&');
      const response = await fetch(url, {
        method: 'GET',
        headers: { 'Accept': 'application/json' },
      });

      if (!response.ok) return;

      const data = await response.json();
      const activities: ActivityStatus[] = data.activities;

      activities.forEach(status => {
        const card = document.getElementById(status.activityId);
        if (!card) return;

        const registerBtn = card.querySelector('.register-btn') as HTMLElement;
        const statusEl = card.querySelector('.registration-status') as HTMLElement;

        if (status.isFull) {
          // Activity is full - hide register button and show message
          if (registerBtn) {
            registerBtn.style.display = 'none';
          }
          if (statusEl) {
            statusEl.textContent = `Sorry, this ${status.kind} is full`;
            statusEl.style.color = '#991b1b';
          }
        } else if (status.spotsRemaining !== null && status.spotsRemaining <= 3) {
          // Low spots - show warning
          if (statusEl) {
            statusEl.textContent = `Only ${status.spotsRemaining} spot${status.spotsRemaining === 1 ? '' : 's'} left!`;
            statusEl.style.color = '#d97706';
          }
        }
      });
    } catch (error) {
      console.error('Failed to fetch activity status:', error);
    }
  }

  // Run on page load
  document.addEventListener('DOMContentLoaded', async () => {
    const upcomingIds = categorizeActivities();
    await updateRegistrationStatus(upcomingIds);
  });
</script> 