---
import { getCollection, render } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import FullWidthLayout from '../layouts/FullWidthLayout.astro';
import ActivityCard from '../components/ActivityCard.astro';
import { Temporal } from '@js-temporal/polyfill';
import { getHourAndMinute } from '../lib/datelib';

const activities = await getCollection('activities');
const now = Date.now();

// Sort and render activities
const renderedActivities = await Promise.all(
  activities
    .sort((a, b) => {
      const [monthA, dayA, yearA] = a.data.startDate.split('/').map(Number);
      const [monthB, dayB, yearB] = b.data.startDate.split('/').map(Number);
      const startTimeA = getHourAndMinute(a.data.startTime);
      const startTimeB = getHourAndMinute(b.data.startTime);
      const dateA = Temporal.PlainDateTime.from({
        year: yearA,
        month: monthA,
        day: dayA,
        ...startTimeA,
      });
      const dateB = Temporal.PlainDateTime.from({
        year: yearB,
        month: monthB,
        day: dayB,
        ...startTimeB,
      });
      return Temporal.PlainDateTime.compare(dateA, dateB);
    })
    .map(async (activity: CollectionEntry<'activities'>) => {
      const { Content } = await render(activity);
      const [month, day, year] = activity.data.startDate.split('/').map(Number);
      const startDateTime = new Date(year, month - 1, day).getTime();
      return {
        ...activity,
        Content,
        isCurrent: startDateTime < now,
        isUpcoming: startDateTime >= now,
      };
    })
);

// Split into current and upcoming
const currentActivities = renderedActivities.filter(a => a.isCurrent);
const upcomingActivities = renderedActivities.filter(a => a.isUpcoming);
---


<FullWidthLayout>
  <section class="activities-section">
    <h1>Activities</h1>
    {currentActivities.length > 0 && (
      <details class="activity-group">
        <summary>
          <span class="summary-text">Current Activities</span>
          <span class="summary-count">{currentActivities.length}</span>
        </summary>
        <div class="activities-grid">
          {currentActivities.map((activity) => (
            <ActivityCard
              activityId={activity.id}
              name={activity.data.name}
              image={activity.data.image}
              startDate={activity.data.startDate}
              startTime={activity.data.startTime}
              duration={activity.data.duration}
              repeat={activity.data.repeat}
              ageMin={activity.data.ageMin}
              ageMax={activity.data.ageMax}
              cost={activity.data.cost}
              instructors={activity.data.instructors}
              sizeMax={activity.data.sizeMax}
            />
          ))}
        </div>
      </details>
    )}

    {upcomingActivities.length > 0 && (
      <details class="activity-group" open>
        <summary>
          <span class="summary-text">Upcoming Activities</span>
          <span class="summary-count">{upcomingActivities.length}</span>
        </summary>
        <div class="activities-grid">
          {upcomingActivities.map((activity) => (
            <ActivityCard
              activityId={activity.id}
              name={activity.data.name}
              image={activity.data.image}
              startDate={activity.data.startDate}
              startTime={activity.data.startTime}
              duration={activity.data.duration}
              repeat={activity.data.repeat}
              ageMin={activity.data.ageMin}
              ageMax={activity.data.ageMax}
              cost={activity.data.cost}
              instructors={activity.data.instructors}
              sizeMax={activity.data.sizeMax}
            />
          ))}
        </div>
      </details>
    )}

  </section>
</FullWidthLayout>

<style>
  .activities-section {
    padding: 2rem;
  }

  h1 {
    margin-bottom: 1.5rem;
    font-size: 2.5rem;
    color: #333;
    padding: 0 1rem;
  }

  .activity-group {
    margin-bottom: 2rem;
  }

  .activity-group summary {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    font-size: 1.25rem;
    font-weight: 600;
    color: #333;
    cursor: pointer;
    list-style: none;
    border-bottom: 2px solid #eee;
    margin-bottom: 1.5rem;
  }

  .activity-group summary::-webkit-details-marker {
    display: none;
  }

  .activity-group summary::before {
    content: 'â–¶';
    font-size: 0.75rem;
    transition: transform 0.2s ease;
  }

  .activity-group[open] summary::before {
    transform: rotate(90deg);
  }

  .activity-group summary:hover {
    background: #f9f9f9;
  }

  .summary-text {
    flex: 1;
  }

  .summary-count {
    background: #eee;
    color: #666;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.875rem;
    font-weight: 500;
  }

  .activities-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, 320px);
    gap: 2rem;
    padding: 0 1rem;
    justify-content: center;
  }

  /* Responsive breakpoints */
  @media (max-width: 768px) {
    .activities-section {
      padding: 1rem;
    }

    .activities-grid {
      grid-template-columns: 320px;
      padding: 0;
      justify-content: center;
    }

    h1 {
      font-size: 2rem;
      padding: 0;
      text-align: center;
    }

    .activity-group summary {
      font-size: 1.1rem;
      padding: 0.75rem;
    }
  }
</style> 