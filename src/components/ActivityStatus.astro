---
import { getPool, getActiveRegistrationCount } from '../lib/db';

interface Props {
  activityId: string;
  kind: string;
  sizeMax?: number;
}

const { activityId, kind, sizeMax } = Astro.props;

// Cache this server island response for up to 15 minutes
Astro.response.headers.set('Cache-Control', 'public, max-age=900, s-maxage=900, stale-while-revalidate=60');

// Fetch registration count from database
let registeredCount = 0;
let error = false;

try {
  const pool = getPool();
  const client = await pool.connect();
  try {
    registeredCount = await getActiveRegistrationCount(client, activityId);
  } finally {
    client.release();
  }
} catch (e) {
  console.error('Failed to fetch activity status:', e);
  error = true;
}

// If no sizeMax, there's no capacity limit
const hasCapacity = sizeMax !== undefined && sizeMax > 0;
const isFull = hasCapacity && registeredCount >= sizeMax;
const spotsRemaining = hasCapacity ? Math.max(0, sizeMax - registeredCount) : null;
const isLow = spotsRemaining !== null && spotsRemaining > 0 && spotsRemaining <= 3;
---

<>
  {error ? (
    <div class="error-message">
      Sorry, we couldn't check the status of this {kind}
    </div>
    <slot />
  ) : null}

  {isLow && (
    <div class="spots-low-message">
      Only {spotsRemaining} spot{spotsRemaining === 1 ? '' : 's'} left!
    </div>
  )}
  
  {isFull ? (
    <div class="activity-full-message">
      Sorry, this {kind} is full
    </div>
  ) : (
    <slot />
  )}
</>


<style>
  .spots-remaining {
    margin: 0.75rem 0;
    color: #666;
    font-size: 0.9rem;
  }

  .spots-remaining .spots-count {
    font-weight: 600;
  }

  .spots-remaining.spots-low .spots-count {
    color: #d97706;
  }

  .spots-remaining.spots-full .spots-count {
    color: #991b1b;
  }

  .spots-low-message {
    text-align: center;
    padding: 0.75rem 1rem;
    margin-top: 1rem;
    background: #fef3c7;
    color: #92400e;
    border: 2px solid #fde68a;
    border-radius: var(--radius-button);
    font-weight: 600;
  }

  .activity-full-message {
    text-align: center;
    padding: 0.75rem 1rem;
    margin-top: 1rem;
    background: #fee2e2;
    color: #991b1b;
    border: 2px solid #fecaca;
    border-radius: var(--radius-button);
    font-weight: 600;
  }
</style>

