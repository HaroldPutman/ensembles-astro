---
import { getPool, getActiveRegistrationCount } from '../lib/db';
import { Icon } from 'astro-icon/components';

interface Props {
  activityId: string;
  kind: string;
  sizeMax?: number;
  startTimestamp?: number; // Unix timestamp in milliseconds
}

const { activityId, kind, sizeMax, startTimestamp } = Astro.props;

// Cache this server island response for up to 15 minutes
Astro.response.headers.set('Cache-Control', 'public, max-age=900, s-maxage=900, stale-while-revalidate=60');

// Check if class has already started
const hasStarted = kind === 'class' && startTimestamp && startTimestamp < Date.now();

// Fetch registration count from database
let registeredCount = 0;
let error = false;

// Skip DB check if class has already started
if (!hasStarted) {
  try {
    const pool = getPool();
    const client = await pool.connect();
    try {
      registeredCount = await getActiveRegistrationCount(client, activityId);
    } finally {
      client.release();
    }
  } catch (e) {
    console.error('Failed to fetch activity status:', e);
    error = true;
  }
}

// If no sizeMax, there's no capacity limit
const hasCapacity = sizeMax !== undefined && sizeMax > 0;
const isFull = hasCapacity && registeredCount >= sizeMax;
const spotsRemaining = hasCapacity ? Math.max(0, sizeMax - registeredCount) : null;
const isLow = spotsRemaining !== null && spotsRemaining > 0 && spotsRemaining <= 3;
---

<>
  {hasStarted ? (
    <div class="activity-started-message">
      This class has already started and is no longer open for registration.
    </div>
  ) : error ? (
    <>
      <div class="error-message">
        Sorry, we couldn't check the status of this {kind}
      </div>
      <slot />
    </>
  ) : (
    <>
      {isLow && (
        <p class="spots-low-message">
          <Icon name="mdi:alert" width="20" height="20" /> Only {spotsRemaining} spot{spotsRemaining === 1 ? '' : 's'} left!
        </p>
      )}
      
      {isFull ? (
        <div class="activity-full-message">
          Sorry, this {kind} is full
        </div>
      ) : (
        <slot />
      )}
    </>
  )}
</>


<style>
  .error-message {
    text-align: center;
    padding: 0.75rem 1rem;
    margin-top: 1rem;
    background: #fef2f2;
    color: #b91c1c;
    border: 1px solid #fecaca;
    border-radius: var(--radius-button);
    font-size: 0.9rem;
  }

  .spots-remaining {
    margin: 0.75rem 0;
    color: #666;
    font-size: 0.9rem;
  }

  .spots-remaining .spots-count {
    font-weight: 600;
  }

  .spots-remaining.spots-low .spots-count {
    color: #d97706;
  }

  .spots-remaining.spots-full .spots-count {
    color: #991b1b;
  }

  .spots-low-message {
    margin: 0.5rem 0 0.5rem 0;
    color: #b45309;
    font-size: 0.875rem;
    font-style: italic;
    display: flex;
    align-items: center;
    gap: 0.4em;
  }

  .activity-full-message {
    text-align: center;
    padding: 0.75rem 1rem;
    margin-top: 1rem;
    background: #fee2e2;
    color: #991b1b;
    border: 2px solid #fecaca;
    border-radius: var(--radius-button);
    font-weight: 600;
  }

  .activity-started-message {
    text-align: center;
    padding: 0.75rem 1rem;
    margin-top: 1rem;
    background: #f3f4f6;
    color: #4b5563;
    border: 1px solid #d1d5db;
    border-radius: var(--radius-button);
  }
</style>

